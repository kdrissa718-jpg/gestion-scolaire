<!-- Contrôles : démarrage / nombre de créneaux / import-export -->
<div class="edt-controls" style="margin:12px 0;align-items:center;gap:8px">
    <label style="font-weight:700">Heure de début</label>
    <input id="startHour" type="time" value="07:00" style="padding:6px;border-radius:6px;border:1px solid #ccc">
    <label style="font-weight:700">Créneaux</label>
    <input id="slotCount" type="number" min="1" max="24" value="11" style="width:72px;padding:6px;border-radius:6px;border:1px solid #ccc">
    <button id="generateBtn" class="btn">Générer</button>
    <button id="clearBtn" class="btn secondary">Réinitialiser</button>
        <button id="exportBtn" class="btn secondary">Exporter JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button id="importBtn" class="btn secondary">Importer JSON</button>
        <label style="font-weight:700">Vue</label>
        <select id="viewMode" style="padding:6px;border-radius:6px;border:1px solid #ccc">
            <option value="table">Tableau</option>
            <option value="cards">Cartes</option>
        </select>
</div>

<table id="emploiDuTemps">
    <thead></thead>
    <tbody></tbody>
</table>

<!DOCTYPE html>
<html lang="fr">
    <head>
        <script>
        /* Emploi du temps dynamique : génération 7 jours x N créneaux, édition et sauvegarde */
        (() => {
            const jours = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
            const table = document.getElementById('emploiDuTemps');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            const startHourInput = document.getElementById('startHour');
            const slotCountInput = document.getElementById('slotCount');
            const generateBtn = document.getElementById('generateBtn');
            const clearBtn = document.getElementById('clearBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');
            const viewMode = document.getElementById('viewMode');

            const STORAGE_KEY = 'emploiDuTemps_v1';

            function generateHourLabels(startHourStr, count) {
                const [hh, mm] = startHourStr.split(':').map(Number);
                const labels = [];
                let curH = hh;
                for (let i=0;i<count;i++){
                    const label = `${String(curH).padStart(2,'0')}h - ${String((curH+1)).padStart(2,'0')}h`;
                    labels.push(label);
                    curH += 1;
                }
                return labels;
            }

            function loadState(){
                return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            }
            function saveState(state){
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }

            function buildTable(startHourStr, slotCount){
                const state = loadState();
                const hours = generateHourLabels(startHourStr, slotCount);

                // thead
                thead.innerHTML = '';
                const trHead = document.createElement('tr');
                const thEmpty = document.createElement('th'); thEmpty.textContent = 'Heure / Jour'; trHead.appendChild(thEmpty);
                jours.forEach((jour, jIndex)=>{
                    const th = document.createElement('th');
                    th.textContent = jour;
                    th.style.cursor = 'pointer';
                    th.title = 'Cliquer pour renommer';
                    th.addEventListener('click', ()=>{
                        const nv = prompt('Renommer le jour :', th.textContent);
                        if(nv!==null){ th.textContent = nv; state.days = state.days||[]; state.days[jIndex]=nv; saveState(state); }
                    });
                    trHead.appendChild(th);
                });
                thead.appendChild(trHead);
  
                // tbody
                tbody.innerHTML = '';
                hours.forEach((hLabel, hIndex)=>{
                    const tr = document.createElement('tr');
                    const th = document.createElement('th'); th.textContent = hLabel; th.style.cursor='pointer'; th.title='Cliquer pour modifier l’intervalle';
                    th.addEventListener('click', ()=>{
                        const nv = prompt('Modifier l’horaire :', th.textContent);
                        if(nv!==null){ th.textContent = nv; state.hours = state.hours||[]; state.hours[hIndex]=nv; saveState(state); }
                    });
                    tr.appendChild(th);

                    jours.forEach((_, jIndex)=>{
                        const td = document.createElement('td');
                        const key = `${hIndex}-${jIndex}`;
                        td.textContent = (state.data && state.data[key]) ? state.data[key] : '';
                        td.addEventListener('click', ()=>{
                            const nv = prompt('Entrer l’activité :', td.textContent);
                            if(nv!==null){ td.textContent = nv; state.data = state.data||{}; state.data[key]=nv; saveState(state); }
                        });
                        td.addEventListener('dblclick', ()=>{
                            if(confirm('Supprimer cette valeur ?')){ td.textContent=''; state.data = state.data||{}; delete state.data[key]; saveState(state); }
                        });
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });

                // persist metadata
                            state.start = startHourStr; state.count = slotCount; saveState(state);
                            // if view is cards, refresh cards view
                            if(viewMode && viewMode.value === 'cards') renderCards(state, hours);
            }

            function renderCards(state, hours){
                // remove existing cards view
                const existing = document.getElementById('cardsView');
                if(existing) existing.remove();

                const container = document.createElement('div');
                container.id = 'cardsView';
                container.className = 'cards-view';

                const colors = ['#e3f2fd','#ffebee','#e8f5e9','#fff3e0','#f3e5f5','#e0f7fa','#fff9c4'];

                hours.forEach((hLabel, hIndex)=>{
                    const card = document.createElement('div');
                    card.className = 'slot-card';
                    const header = document.createElement('div'); header.className='slot-header'; header.textContent = hLabel;
                    card.appendChild(header);

                    const grid = document.createElement('div'); grid.className='slot-grid';
                    jours.forEach((jour, jIndex)=>{
                        const key = `${hIndex}-${jIndex}`;
                        const val = (state.data && state.data[key]) ? state.data[key] : '';
                        const pill = document.createElement('div');
                        pill.className = 'pill';
                        pill.style.background = colors[jIndex % colors.length];
                        const day = document.createElement('div'); day.className='pill-day'; day.textContent = jour;
                        const content = document.createElement('div'); content.className='pill-content'; content.textContent = val || '-';
                        pill.appendChild(day); pill.appendChild(content);
                        pill.addEventListener('click', ()=>{
                            const nv = prompt('Entrer l’activité :', val);
                            if(nv!==null){ state.data = state.data||{}; state.data[key]=nv; saveState(state); renderCards(state, hours); if(viewMode.value==='table') generateFromInputs(); }
                        });
                        grid.appendChild(pill);
                    });
                    card.appendChild(grid);
                    container.appendChild(card);
                });

                // insert after controls
                const controls = document.querySelector('.edt-controls');
                controls.insertAdjacentElement('afterend', container);
            }

            function generateFromInputs(){
                const start = startHourInput.value || '07:00';
                const count = parseInt(slotCountInput.value,10) || 11;
                buildTable(start, count);
                const state = loadState();
                const hours = generateHourLabels(start, count);
                if(viewMode && viewMode.value === 'cards'){
                    // hide table
                    table.style.display = 'none';
                    renderCards(state, hours);
                } else {
                    table.style.display = '';
                    const existing = document.getElementById('cardsView'); if(existing) existing.remove();
                }
            }

            generateBtn.addEventListener('click', generateFromInputs);
            if(viewMode) viewMode.addEventListener('change', ()=>{
                // regenerate view on change
                generateFromInputs();
            });

            clearBtn.addEventListener('click', ()=>{
                if(confirm('Réinitialiser l’emploi du temps (supprime les données sauvegardées) ?')){
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            });

            exportBtn.addEventListener('click', ()=>{
                const data = localStorage.getItem(STORAGE_KEY) || '{}';
                const blob = new Blob([data],{type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download='emploiDuTemps.json'; a.click(); URL.revokeObjectURL(url);
            });

            importBtn.addEventListener('click', ()=> importFile.click());
            importFile.addEventListener('change',(e)=>{
                const f = e.target.files[0]; if(!f) return;
                const reader = new FileReader();
                reader.onload = ()=>{ try{ const obj = JSON.parse(reader.result); localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); alert('Importé. Rechargement.'); location.reload(); }catch(err){alert('Fichier invalide');} };
                reader.readAsText(f);
            });

            // on load: if saved, restore settings
            (function init(){
                const state = loadState();
                if(state.start) startHourInput.value = state.start;
                if(state.count) slotCountInput.value = state.count;
                generateFromInputs();
            })();

        })();
        </script>